(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[405],{8312:function(e,t,i){(window.__NEXT_P=window.__NEXT_P||[]).push(["/",function(){return i(5145)}])},5145:function(e,t,i){"use strict";i.r(t),i.d(t,{default:function(){return z}});var a=i(5893),n=i(7294),s=i(7066),r=i(9477),o=i(3818),l=i(7836);let h=new r.Pa4,u=new r._fP,c=new r.USm;class d extends o.cw{update(e){if(this.target&&this.autoUpdate){this.lookAt(this.target.getWorldPosition(h));let t=this._yaw,i=this._pitch,a=t,n=i;if(this.userTarget){this.lookAt(this.userTarget.getWorldPosition(h)),(this.userLimitAngle<Math.abs(this._yaw)||this.userLimitAngle<Math.abs(this._pitch))&&(this._yaw=t,this._pitch=i);let s=1-Math.exp(-this.smoothFactor*e);this._yawDamped+=(this._yaw-this._yawDamped)*s,this._pitchDamped+=(this._pitch-this._pitchDamped)*s;let l=1-r.M8C.smoothstep(Math.sqrt(t*t+i*i),30,90);a=r.M8C.lerp(t,.6*this._yawDamped,l),n=r.M8C.lerp(i,.6*this._pitchDamped,l),c.set(-this._pitchDamped*r.M8C.DEG2RAD,this._yawDamped*r.M8C.DEG2RAD,0,o.cw.EULER_ORDER),u.setFromEuler(c);let d=this.humanoid.getRawBoneNode("head");this._tempFirstPersonBoneQuat.copy(d.quaternion),d.quaternion.slerp(u,.4),d.updateMatrixWorld()}this.enableSaccade&&(.5<this._saccadeTimer&&.05>Math.random()&&(this._saccadeYaw=(2*Math.random()-1)*5,this._saccadePitch=(2*Math.random()-1)*5,this._saccadeTimer=0),this._saccadeTimer+=e,a+=this._saccadeYaw,n+=this._saccadePitch,this.applier.applyYawPitch(a,n)),this._needsUpdate=!1}this._needsUpdate&&(this._needsUpdate=!1,this.applier.applyYawPitch(this._yaw,this._pitch))}revertFirstPersonBoneQuat(){this.userTarget&&this.humanoid.getNormalizedBoneNode("head").quaternion.copy(this._tempFirstPersonBoneQuat)}constructor(e,t){super(e,t),this.smoothFactor=4,this.userLimitAngle=90,this._saccadeYaw=0,this._saccadePitch=0,this._saccadeTimer=0,this._yawDamped=0,this._pitchDamped=0,this._tempFirstPersonBoneQuat=new r._fP,this.enableSaccade=!0}}class p extends o.Hn{get name(){return"VRMLookAtSmootherLoaderPlugin"}async afterRoot(e){await super.afterRoot(e);let t=e.userData.vrmHumanoid,i=e.userData.vrmLookAt;if(null!=t&&null!=i){let a=new d(t,i.applier);a.copy(i),e.userData.vrmLookAt=a}}}class m{update(){this.analyser.getFloatTimeDomainData(this.timeDomainData);let e=0;for(let t=0;t<2048;t++)e=Math.max(e,Math.abs(this.timeDomainData[t]));return(e=1/(1+Math.exp(-45*e+5)))<.1&&(e=0),{volume:e}}async playFromArrayBuffer(e,t){let i=await this.audio.decodeAudioData(e),a=this.audio.createBufferSource();a.buffer=i,a.connect(this.audio.destination),a.connect(this.analyser),a.start(),t&&a.addEventListener("ended",t)}async playFromURL(e,t){let i=await fetch(e),a=await i.arrayBuffer();this.playFromArrayBuffer(a,t)}constructor(e){this.audio=e,this.analyser=e.createAnalyser(),this.timeDomainData=new Float32Array(2048)}}class _{constructor(e,t){this._lookAtTarget=new r.Tme,t.add(this._lookAtTarget),e.lookAt&&(e.lookAt.target=this._lookAtTarget)}}class v{setEnable(e){return(this._isAutoBlink=e,this._isOpen)?0:this._remainingTime}update(e){if(this._remainingTime>0){this._remainingTime-=e;return}if(this._isOpen&&this._isAutoBlink){this.close();return}this.open()}close(){this._isOpen=!1,this._remainingTime=.12,this._expressionManager.setValue("blink",1)}open(){this._isOpen=!0,this._remainingTime=5,this._expressionManager.setValue("blink",0)}constructor(e){this._expressionManager=e,this._remainingTime=0,this._isAutoBlink=!0,this._isOpen=!0}}class w{playEmotion(e){var t,i,a;if("neutral"!=this._currentEmotion&&(null===(i=this._expressionManager)||void 0===i||i.setValue(this._currentEmotion,0)),"neutral"==e){null===(a=this._autoBlink)||void 0===a||a.setEnable(!0),this._currentEmotion=e;return}let n=(null===(t=this._autoBlink)||void 0===t?void 0:t.setEnable(!1))||0;this._currentEmotion=e,setTimeout(()=>{var t;null===(t=this._expressionManager)||void 0===t||t.setValue(e,1)},1e3*n)}lipSync(e,t){if(this._currentLipSync){var i;null===(i=this._expressionManager)||void 0===i||i.setValue(this._currentLipSync.preset,0)}this._currentLipSync={preset:e,value:t}}update(e){if(this._autoBlink&&this._autoBlink.update(e),this._currentLipSync){var t;let e="neutral"===this._currentEmotion?.5*this._currentLipSync.value:.25*this._currentLipSync.value;null===(t=this._expressionManager)||void 0===t||t.setValue(this._currentLipSync.preset,e)}}constructor(e,t){this._autoLookAt=new _(e,t),this._currentEmotion="neutral",this._currentLipSync=null,e.expressionManager&&(this._expressionManager=e.expressionManager,this._autoBlink=new v(e.expressionManager))}}class f{playEmotion(e){this._expressionController.playEmotion(e)}lipSync(e,t){this._expressionController.lipSync(e,t)}update(e){this._expressionController.update(e)}constructor(e,t){this._expressionController=new w(e,t)}}class y{async loadVRM(e){let t=new l.E;t.register(e=>new o.XX(e,{lookAtPlugin:new p(e)}));let i=await t.loadAsync(e),a=this.vrm=i.userData.vrm;a.scene.name="VRMRoot",o.ck.rotateVRM0(a),this.mixer=new r.Xcj(a.scene),this.emoteController=new f(a,this._lookAtTargetParent)}unLoadVrm(){this.vrm&&(o.ck.deepDispose(this.vrm.scene),this.vrm=null)}async loadAnimation(e){let{vrm:t,mixer:i}=this;if(null==t||null==i)throw Error("You have to load VRM first");let a=e.createAnimationClip(t);i.clipAction(a).play()}async speak(e,t){var i;null===(i=this.emoteController)||void 0===i||i.playEmotion(t),await new Promise(t=>{var i;null===(i=this._lipSync)||void 0===i||i.playFromArrayBuffer(e,()=>{t(!0)})})}update(e){var t,i,a,n;if(this._lipSync){let{volume:e}=this._lipSync.update();null===(n=this.emoteController)||void 0===n||n.lipSync("aa",e)}null===(t=this.emoteController)||void 0===t||t.update(e),null===(i=this.mixer)||void 0===i||i.update(e),null===(a=this.vrm)||void 0===a||a.update(e)}constructor(e){this._lookAtTargetParent=e,this._lipSync=new m(new AudioContext)}}class g{createAnimationClip(e){let t=[];if(t.push(...this.createHumanoidTracks(e)),null!=e.expressionManager&&t.push(...this.createExpressionTracks(e.expressionManager)),null!=e.lookAt){let e=this.createLookAtTrack("lookAtTargetParent.quaternion");null!=e&&t.push(e)}return new r.m7l("Clip",this.duration,t)}createHumanoidTracks(e){var t,i;let a=e.humanoid,n=e.meta.metaVersion,s=[];for(let[e,i]of this.humanoidTracks.rotation.entries()){let o=null===(t=a.getNormalizedBoneNode(e))||void 0===t?void 0:t.name;if(null!=o){let e=new r.yC1("".concat(o,".quaternion"),i.times,i.values.map((e,t)=>"0"===n&&t%2==0?-e:e));s.push(e)}}for(let[e,t]of this.humanoidTracks.translation.entries()){let r=null===(i=a.getNormalizedBoneNode(e))||void 0===i?void 0:i.name;if(null!=r){let e=this.restHipsPosition.y,i=a.getNormalizedAbsolutePose().hips.position[1]/e,o=t.clone();o.values=o.values.map((e,t)=>("0"===n&&t%3!=1?-e:e)*i),o.name="".concat(r,".position"),s.push(o)}}return s}createExpressionTracks(e){let t=[];for(let[i,a]of this.expressionTracks.entries()){let n=e.getExpressionTrackName(i);if(null!=n){let e=a.clone();e.name=n,t.push(e)}}return t}createLookAtTrack(e){if(null==this.lookAtTrack)return null;let t=this.lookAtTrack.clone();return t.name=e,t}constructor(){this.duration=0,this.restHipsPosition=new r.Pa4,this.humanoidTracks={translation:new Map,rotation:new Map},this.expressionTracks=new Map,this.lookAtTrack=null}}function k(e,t){let i=e.length,a=[],n=[],s=0;for(let r=0;r<i;r++){let i=e[r];s<=0&&(s=t,n=[],a.push(n)),n.push(i),s--}return a}let x=new r.yGw,A=new r.Pa4,M=new r._fP,T=new r._fP,P=new r._fP;class E{get name(){return"VRMC_vrm_animation"}async afterRoot(e){var t;let i=e.parser.json,a=i.extensionsUsed;if(null==a||-1==a.indexOf(this.name))return;let n=null===(t=i.extensions)||void 0===t?void 0:t[this.name];if(null==n)return;let s=this._createNodeMap(n),o=await this._createBoneWorldMatrixMap(e,n),l=n.humanoid.humanBones.hips.node,h=(await e.parser.getDependency("node",l)).getWorldPosition(new r.Pa4),u=e.animations.map((e,t)=>{let a=i.animations[t],n=this._parseAnimation(e,a,s,o);return n.restHipsPosition=h,n});e.userData.vrmAnimations=u}_createNodeMap(e){var t,i,a,n,s;let r=new Map,o=new Map,l=null===(t=e.humanoid)||void 0===t?void 0:t.humanBones;l&&Object.entries(l).forEach(e=>{let[t,i]=e,{node:a}=i;r.set(a,t)});let h=null===(i=e.expressions)||void 0===i?void 0:i.preset;h&&Object.entries(h).forEach(e=>{let[t,i]=e,{node:a}=i;o.set(a,t)});let u=null===(a=e.expressions)||void 0===a?void 0:a.custom;return u&&Object.entries(u).forEach(e=>{let[t,i]=e,{node:a}=i;o.set(a,t)}),{humanoidIndexToName:r,expressionsIndexToName:o,lookAtIndex:null!==(s=null===(n=e.lookAt)||void 0===n?void 0:n.node)&&void 0!==s?s:null}}async _createBoneWorldMatrixMap(e,t){e.scene.updateWorldMatrix(!1,!0);let i=await e.parser.getDependencies("node"),a=new Map;for(let[e,{node:r}]of Object.entries(t.humanoid.humanBones)){let t=i[r];if(a.set(e,t.matrixWorld),"hips"===e){var n,s;a.set("hipsParent",null!==(s=null===(n=t.parent)||void 0===n?void 0:n.matrixWorld)&&void 0!==s?s:x)}}return a}_parseAnimation(e,t,i,a){let n=e.tracks,s=t.channels,l=new g;return l.duration=e.duration,s.forEach((e,t)=>{let{node:s,path:h}=e.target,u=n[t];if(null==s)return;let c=i.humanoidIndexToName.get(s);if(null!=c){let e=o.j$[c];for(;null!=e&&null==a.get(e);)e=o.j$[e];if(null!=e||(e="hipsParent"),"translation"===h){let e=a.get("hipsParent"),t=k(u.values,3).flatMap(t=>A.fromArray(t).applyMatrix4(e).toArray()),i=u.clone();i.values=new Float32Array(t),l.humanoidTracks.translation.set(c,i)}else if("rotation"===h){let t=a.get(c),i=a.get(e);M.setFromRotationMatrix(t).normalize().invert(),T.setFromRotationMatrix(i).normalize();let n=k(u.values,4).flatMap(e=>P.fromArray(e).premultiply(T).multiply(M).toArray()),s=u.clone();s.values=new Float32Array(n),l.humanoidTracks.rotation.set(c,s)}else throw Error('Invalid path "'.concat(h,'"'));return}let d=i.expressionsIndexToName.get(s);if(null!=d){if("translation"===h){let e=u.times,t=new Float32Array(u.values.length/3);for(let e=0;e<t.length;e++)t[e]=u.values[3*e];let i=new r.dUE("".concat(d,".weight"),e,t);l.expressionTracks.set(d,i)}else throw Error('Invalid path "'.concat(h,'"'));return}if(s===i.lookAtIndex){if("rotation"===h)l.lookAtTrack=u;else throw Error('Invalid path "'.concat(h,'"'))}}),l}constructor(e){this.parser=e}}let C=new l.E;async function D(e){let t=(await C.loadAsync(e)).userData.vrmAnimations[0];return null!=t?t:null}C.register(e=>new E(e));var R=i(9365),L=i(1752),B=i.n(L);function S(e){let{publicRuntimeConfig:t}=B()();return t.root+e}class b{loadVrm(e){var t;(null===(t=this.model)||void 0===t?void 0:t.vrm)&&this.unloadVRM(),this.model=new y(this._camera||new r.Tme),this.model.loadVRM(e).then(async()=>{var e;if(!(null===(e=this.model)||void 0===e?void 0:e.vrm))return;this.model.vrm.scene.traverse(e=>{e.frustumCulled=!1}),this._scene.add(this.model.vrm.scene);let t=await D(S("/idle_loop.vrma"));t&&this.model.loadAnimation(t),requestAnimationFrame(()=>{this.resetCamera()})})}unloadVRM(){var e,t;(null===(e=this.model)||void 0===e?void 0:e.vrm)&&(this._scene.remove(this.model.vrm.scene),null===(t=this.model)||void 0===t||t.unLoadVrm())}setup(e){var t,i;let a=e.parentElement,n=(null==a?void 0:a.clientWidth)||e.width,s=(null==a?void 0:a.clientHeight)||e.height;this._renderer=new r.CP7({canvas:e,alpha:!0,antialias:!0}),this._renderer.outputColorSpace=r.KI_,this._renderer.setSize(n,s),this._renderer.setPixelRatio(window.devicePixelRatio),this._camera=new r.cPb(20,n/s,.1,20),this._camera.position.set(0,1.3,1.5),null===(t=this._cameraControls)||void 0===t||t.target.set(0,1.3,0),null===(i=this._cameraControls)||void 0===i||i.update(),this._cameraControls=new R.z(this._camera,this._renderer.domElement),this._cameraControls.screenSpacePanning=!0,this._cameraControls.update(),window.addEventListener("resize",()=>{this.resize()}),this.isReady=!0,this.update()}resize(){if(!this._renderer)return;let e=this._renderer.domElement.parentElement;e&&(this._renderer.setPixelRatio(window.devicePixelRatio),this._renderer.setSize(e.clientWidth,e.clientHeight),this._camera&&(this._camera.aspect=e.clientWidth/e.clientHeight,this._camera.updateProjectionMatrix()))}resetCamera(){var e,t,i,a,n;let s=null===(t=this.model)||void 0===t?void 0:null===(e=t.vrm)||void 0===e?void 0:e.humanoid.getNormalizedBoneNode("head");if(s){let e=s.getWorldPosition(new r.Pa4);null===(i=this._camera)||void 0===i||i.position.set(this._camera.position.x,e.y,this._camera.position.z),null===(a=this._cameraControls)||void 0===a||a.target.set(e.x,e.y,e.z),null===(n=this._cameraControls)||void 0===n||n.update()}}constructor(){this.update=()=>{requestAnimationFrame(this.update);let e=this._clock.getDelta();this.model&&this.model.update(e),this._renderer&&this._camera&&this._renderer.render(this._scene,this._camera)},this.isReady=!1;let e=new r.xsS;this._scene=e;let t=new r.Ox3(16777215,.6);t.position.set(1,1,1).normalize(),e.add(t);let i=new r.Mig(16777215,.4);e.add(i),this._clock=new r.SUY,this._clock.start()}}let V=new b,N=(0,n.createContext)({viewer:V});function F(){let{viewer:e}=(0,n.useContext)(N),t=(0,n.useCallback)(t=>{t&&(e.setup(t),e.loadVrm(S("/Zundamon_VRM_10.vrm")),t.addEventListener("dragover",function(e){e.preventDefault()}),t.addEventListener("drop",function(t){var i;t.preventDefault();let a=null===(i=t.dataTransfer)||void 0===i?void 0:i.files;if(!a)return;let n=a[0];if(n&&"vrm"===n.name.split(".").pop()){let t=new Blob([n],{type:"application/octet-stream"}),i=window.URL.createObjectURL(t);e.loadVrm(i)}}))},[e]);return(0,a.jsx)("div",{style:{position:"absolute",top:0,left:0,width:"100vw",height:"100svh",zIndex:-10},children:(0,a.jsx)("canvas",{ref:t,style:{height:"100%",width:"100%"}})})}function z(){let{viewer:e}=(0,n.useContext)(N),t="https://chat.ikokujin.baby",i=async()=>{var i;let a=await s.Z.get("".concat(t,"/speakers"));console.log(a);let n=a.data.find(e=>"ずんだもん"===e.name),r=n.styles.find(e=>"あまあま"===e.name).id;console.log(n);let o=await s.Z.post("".concat(t,"/audio_query"),null,{params:{text:"パンツ見せてくれませんか?",speaker:r}});console.log(o.data);let l=await s.Z.post("".concat(t,"/synthesis"),o.data,{responseType:"arraybuffer",params:{speaker:r}});null===(i=e.model)||void 0===i||i.speak(l.data,"neutral")};return(0,a.jsxs)("div",{className:"font-M_PLUS_2",children:[(0,a.jsx)(F,{}),(0,a.jsx)("button",{onClick:i,children:"test"})]})}}},function(e){e.O(0,[737,86,60,888,774,179],function(){return e(e.s=8312)}),_N_E=e.O()}]);